<div th:fragment="content" class="content-wrapper report-page">
    <h2 class="report-title">Thống kê - báo cáo</h2>
  
    <div th:if="${error}" class="alert alert-error">
      <p th:text="${error}"></p>
    </div>
  
    <form class="report-form" th:action="@{/admin/report}" method="post" th:object="${filter}">
      <fieldset class="report-types">
        <legend>Loại báo cáo</legend>
        <label class="report-option">
          <input type="radio" th:field="*{type}" value="FINANCE"> Thu – Chi
        </label>
        <label class="report-option">
          <input type="radio" th:field="*{type}" value="SALES"> Bán hàng
        </label>
        <label class="report-option">
          <input type="radio" th:field="*{type}" value="STAFF"> Nhân viên
        </label>
      </fieldset>
      <div class="report-dates" id="reportDates" th:classappend="${filter.type == 'STAFF' ? ' is-hidden' : ''}">
        <label class="report-date">
          <span>Từ ngày:</span>
          <input type="date" th:field="*{fromDate}" required>
        </label>
        <label class="report-date">
          <span>Đến ngày:</span>
          <input type="date" th:field="*{toDate}" required>
        </label>
      </div>
      <div class="report-actions">
        <button class="btn btn-primary" type="submit">Xem</button>
        <button class="btn btn-secondary no-print" type="button" onclick="window.print()">In</button>
      </div>
    </form>
  
    
    <div th:if="${filter.type == 'FINANCE'}">
      <div class="report-chart" th:if="${reportData != null and !reportData.isEmpty()}">
        <canvas id="financeChart"></canvas>
      </div>
      <table class="data-table report-table"
             th:if="${reportData != null and !reportData.isEmpty()}">
      <thead>
        <tr>
          <th>Ngày</th>
          <th>Thu</th>
          <th>Chi</th>
        </tr>
      </thead>
  
      <tbody>
        <tr th:each="row : ${reportData}">
          <td th:text="${#temporals.format(row.ngay,'dd/MM')}"></td>
          <td th:text="${#numbers.formatDecimal(row.thu,0,'COMMA',0,'POINT')}"></td>
          <td th:text="${#numbers.formatDecimal(row.chi,0,'COMMA',0,'POINT')}"></td>
        </tr>
      </tbody>
  
      <tfoot>
        <tr>
          <th>Tổng</th>
          <th th:text="${#numbers.formatDecimal(#aggregates.sum(reportData.![thu]),0,'COMMA',0,'POINT')}"></th>
          <th th:text="${#numbers.formatDecimal(#aggregates.sum(reportData.![chi]),0,'COMMA',0,'POINT')}"></th>
        </tr>
      </tfoot>
      </table>

      <p class="report-empty" th:if="${reportData == null or reportData.isEmpty()}">
        Chưa có dữ liệu
      </p>
    </div>

    
    <div th:if="${filter.type == 'SALES'}">
      <h3 class="report-subtitle">Bán hàng theo ngày</h3>
      <div class="report-chart" th:if="${salesByDay != null and !salesByDay.isEmpty()}">
        <canvas id="salesChart"></canvas>
      </div>
      <table class="data-table report-table"
             th:if="${salesByDay != null and !salesByDay.isEmpty()}">
      <thead>
        <tr>
          <th>Ngày</th>
          <th>Số hóa đơn</th>
          <th>Doanh thu</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="r : ${salesByDay}">
          <td th:text="${#temporals.format(r.ngay,'dd/MM')}"></td>
          <td th:text="${r.soHoaDon}"></td>
          <td th:text="${#numbers.formatDecimal(r.doanhThu,0,'COMMA',0,'POINT')}"></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th>Tổng</th>
          <th th:text="${#aggregates.sum(salesByDay.![soHoaDon])}"></th>
          <th th:text="${#numbers.formatDecimal(#aggregates.sum(salesByDay.![doanhThu]),0,'COMMA',0,'POINT')}"></th>
        </tr>
      </tfoot>
      </table>

      <p class="report-empty" th:if="${salesByDay == null or salesByDay.isEmpty()}">
        Chưa có dữ liệu bán hàng
      </p>
    </div>


    
    <div th:if="${filter.type == 'STAFF'}">
      <h3 class="report-subtitle">Báo cáo nhân viên</h3>
      <div class="report-chart report-chart--compact" th:if="${staffReport != null and !staffReport.isEmpty()}">
        <canvas id="staffChart"></canvas>
      </div>
      <p class="report-empty" th:if="${staffReport == null or staffReport.isEmpty()}">
        Chưa có dữ liệu nhân viên
      </p>
    </div>

    <script th:src="@{/js/chart.umd.min.js}" src="/js/chart.umd.min.js"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      var reportLabels = /*[[${reportLabels}]]*/ [];
      var reportThuData = /*[[${reportThuData}]]*/ [];
      var reportChiData = /*[[${reportChiData}]]*/ [];
      var salesLabels = /*[[${salesLabels}]]*/ [];
      var salesDoanhThuData = /*[[${salesDoanhThuData}]]*/ [];
      var salesHoaDonData = /*[[${salesHoaDonData}]]*/ [];
      var staffLabels = /*[[${staffLabels}]]*/ [];
      var staffCounts = /*[[${staffCounts}]]*/ [];

      function buildFinanceChart() {
        var canvas = document.getElementById('financeChart');
        if (!canvas || !reportLabels.length) return;
        new Chart(canvas, {
          type: 'line',
          data: {
            labels: reportLabels,
            datasets: [
              {
                label: 'Thu',
                data: reportThuData,
                borderColor: '#16a34a',
                backgroundColor: 'rgba(22, 163, 74, 0.15)',
                tension: 0.2
              },
              {
                label: 'Chi',
                data: reportChiData,
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.15)',
                tension: 0.2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }

      function buildSalesChart() {
        var canvas = document.getElementById('salesChart');
        if (!canvas || !salesLabels.length) return;
        new Chart(canvas, {
          type: 'bar',
          data: {
            labels: salesLabels,
            datasets: [
              {
                label: 'Doanh thu',
                data: salesDoanhThuData,
                backgroundColor: 'rgba(14, 116, 144, 0.55)',
                borderColor: '#0e7490',
                borderWidth: 1
              },
              {
                label: 'Số hóa đơn',
                data: salesHoaDonData,
                type: 'line',
                borderColor: '#f97316',
                backgroundColor: 'rgba(249, 115, 22, 0.2)',
                yAxisID: 'y1',
                tension: 0.2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            },
            scales: {
              y: { beginAtZero: true },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false }
              }
            }
          }
        });
      }

      function buildStaffChart() {
        var canvas = document.getElementById('staffChart');
        if (!canvas || !staffLabels.length) return;
        new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: staffLabels,
            datasets: [
              {
                data: staffCounts,
                backgroundColor: ['#22c55e', '#f97316', '#0ea5e9', '#a855f7']
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        buildFinanceChart();
        buildSalesChart();
        buildStaffChart();
        var datesWrap = document.getElementById('reportDates');
        var dateInputs = datesWrap ? datesWrap.querySelectorAll('input[type="date"]') : [];
        function toggleDatesVisibility() {
          var staffRadio = document.querySelector('input[name="type"][value="STAFF"]');
          var isStaff = staffRadio && staffRadio.checked;
          if (!datesWrap) return;
          if (isStaff) {
            datesWrap.classList.add('is-hidden');
            dateInputs.forEach(function(input){
              input.disabled = true;
              input.required = false;
            });
          } else {
            datesWrap.classList.remove('is-hidden');
            dateInputs.forEach(function(input){
              input.disabled = false;
              input.required = true;
            });
          }
        }
        document.querySelectorAll('input[name="type"]').forEach(function(radio){
          radio.addEventListener('change', toggleDatesVisibility);
        });
        toggleDatesVisibility();
      });
      /*]]>*/
    </script>
  </div>
  
