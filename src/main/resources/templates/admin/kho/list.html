<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
  <div th:fragment="content" class="content-wrapper">
    <h1>Kho hàng</h1>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div class="warehouse-panels">
      <div class="form-box" th:if="${!editMode}">
        <h2 style="margin:0 0 10px;">Nhập hàng hóa</h2>
        <form th:action="@{/admin/warehouse/create}" th:object="${form}" method="post" novalidate>
          <div class="form-group">
            <label>Tên hàng</label>
            <input type="text" th:field="*{tenHangHoa}">
            <div class="field-error" th:if="${#fields.hasErrors('tenHangHoa')}" th:errors="*{tenHangHoa}"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Số lượng</label>
              <input type="hidden" th:field="*{soLuong}" th:id="'nhapSoLuong'">
              <input type="text" id="nhapSoLuongDisplay" data-target="nhapSoLuong" inputmode="numeric"
                     th:value="${form.soLuong != null ? #numbers.formatDecimal(form.soLuong,0,'POINT',0,'COMMA') : ''}">
              <div class="field-error" th:if="${#fields.hasErrors('soLuong')}" th:errors="*{soLuong}"></div>
            </div>
            <div class="form-group">
              <label>Đơn giá</label>
              <input type="hidden" th:field="*{donGia}" th:id="'nhapDonGia'">
              <input type="text" id="nhapDonGiaDisplay" data-target="nhapDonGia" inputmode="numeric"
                     th:value="${form.donGia != null ? #numbers.formatDecimal(form.donGia,0,'POINT',0,'COMMA') : ''}">
              <div class="field-error" th:if="${#fields.hasErrors('donGia')}" th:errors="*{donGia}"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Đơn vị</label>
              <select th:field="*{donViTinhId}">
                <option value="">-- Chọn đơn vị --</option>
                <option th:each="dv : ${donViTinhs}" th:value="${dv.maDonViTinh}" th:text="${dv.tenDonVi}"></option>
              </select>
              <div class="field-error" th:if="${#fields.hasErrors('donViTinhId')}" th:errors="*{donViTinhId}"></div>
            
            </div>
            <div class="form-group">
              <label>Ngày nhập</label>
              <input type="datetime-local" th:field="*{ngayNhap}" th:attr="min=${minDate}">
              <div class="field-error" th:if="${#fields.hasErrors('ngayNhap')}" th:errors="*{ngayNhap}"></div>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Nhập hàng</button>
          </div>
        </form>
      </div>

      <div class="form-box" th:if="${editMode}">
        <h2 style="margin:0 0 10px;">Chỉnh sửa hàng hóa</h2>
        <form th:action="@{/admin/warehouse/edit}" th:object="${editForm}" method="post" novalidate>
          <input type="hidden" name="page" th:value="${page}" />
          <input type="hidden" name="keyword" th:value="${keyword}" />
          <input type="hidden" th:field="*{id}" />
          <div class="form-group">
            <label>Tên hàng</label>
            <input type="text" th:field="*{tenHangHoa}">
            <div class="field-error" th:if="${#fields.hasErrors('tenHangHoa')}" th:errors="*{tenHangHoa}"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Số lượng</label>
              <input type="hidden" th:field="*{soLuong}" th:id="'editSoLuong'">
              <input type="text" id="editSoLuongDisplay" data-target="editSoLuong" inputmode="numeric"
                     th:value="${editForm.soLuong != null ? #numbers.formatDecimal(editForm.soLuong,0,'POINT',0,'COMMA') : ''}">
              <div class="field-error" th:if="${#fields.hasErrors('soLuong')}" th:errors="*{soLuong}"></div>
            </div>
            <div class="form-group">
              <label>Đơn giá</label>
              <input type="hidden" th:field="*{donGia}" th:id="'editDonGia'">
              <input type="text" id="editDonGiaDisplay" data-target="editDonGia" inputmode="numeric"
                     th:value="${editForm.donGia != null ? #numbers.formatDecimal(editForm.donGia,0,'POINT',0,'COMMA') : ''}">
              <div class="field-error" th:if="${#fields.hasErrors('donGia')}" th:errors="*{donGia}"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Đơn vị</label>
              <input type="hidden" th:field="*{donViTinhId}" />
              <select th:field="*{donViTinhId}" disabled>
                <option value="">-- Chọn đơn vị --</option>
                <option th:each="dv : ${donViTinhs}" th:value="${dv.maDonViTinh}" th:text="${dv.tenDonVi}"></option>
              </select>
              <div class="field-error" th:if="${#fields.hasErrors('donViTinhId')}" th:errors="*{donViTinhId}"></div>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Lưu</button>
            <a th:href="@{/admin/warehouse(page=${page}, keyword=${keyword})}" class="btn btn-cancel">Hủy</a>
          </div>
        </form>
      </div>
      
      <div class="form-box">
        <h2 style="margin:0 0 10px;">Xuất hàng hóa</h2>
        <form th:action="@{/admin/warehouse/export}" th:object="${xuatForm}" method="post" novalidate>
          <div class="form-group">
            <label>Hàng hóa</label>
            <select th:field="*{hangHoaId}">
              <option value="">-- Chọn hàng hóa --</option>
              <option th:each="hh : ${hangHoas}" th:value="${hh.maHangHoa}"
                      th:text="${hh.tenHangHoa + ' | ' + hh.donVi + ' (Tồn: ' + #numbers.formatDecimal(hh.soLuong,0,'POINT',0,'COMMA') + ')'}"></option>
            </select>
            <div class="field-error" th:if="${#fields.hasErrors('hangHoaId')}" th:errors="*{hangHoaId}"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Số lượng xuất</label>
              <input type="hidden" th:field="*{soLuong}" th:id="'xuatSoLuong'">
              <input type="text" id="xuatSoLuongDisplay" data-target="xuatSoLuong" inputmode="numeric"
                     th:value="${xuatForm.soLuong != null ? #numbers.formatDecimal(xuatForm.soLuong,0,'POINT',0,'COMMA') : ''}">
              <div class="field-error" th:if="${#fields.hasErrors('soLuong')}" th:errors="*{soLuong}"></div>
            </div>
            <div class="form-group">
              <label>Ngày xuất</label>
              <input type="datetime-local" th:field="*{ngayXuat}" th:attr="min=${minDate}" />
              <div class="field-error" th:if="${#fields.hasErrors('ngayXuat')}" th:errors="*{ngayXuat}"></div>
            </div>
          </div>
          <div class="form-actions" style="margin-top:8px;">
            <button type="submit" class="btn btn-danger">Xuất hàng</button>
          </div>
        </form>
      </div>
    </div>

    <form method="get" th:action="@{/admin/warehouse}" class="mb-3" style="margin-top:12px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="text" name="keyword" placeholder="Tìm theo tên hàng hóa..." th:value="${keyword}" />
        <button class="btn btn-secondary">Tìm kiếm</button>
        <a th:href="@{/admin/warehouse}" class="btn btn-outline-secondary">Reset</a>
      </div>
    </form>

    <table class="data-table table-actions">
      <thead>
        <tr>
          <th>Tên hàng</th>
          <th>Số lượng</th>
          <th>Đơn vị</th>
          <th class="text-right">Đơn giá</th>
          <th>Ngày nhập gần nhất</th>
          <th>Ngày xuất gần nhất</th>
          <th class="text-center">Hành động</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="item : ${items}">
          <td th:text="${item.tenHangHoa}"></td>
          <td th:text="${#numbers.formatDecimal(item.soLuong,0,'POINT',0,'COMMA')}"></td>
          <td th:text="${item.donVi}"></td>
          <td class="text-right" th:text="${#numbers.formatDecimal(item.donGia,0,'POINT',0,'COMMA')}"></td>
          <td th:text="${item.ngayNhapGanNhat != null
            ? #temporals.format(item.ngayNhapGanNhat,'HH:mm dd/MM/yyyy')
            : '-'}"></td>
          <td th:text="${item.ngayXuatGanNhat != null
            ? #temporals.format(item.ngayXuatGanNhat,'HH:mm dd/MM/yyyy')
            : '-'}"></td>
          <td class="action-buttons">
            <a th:href="@{/admin/warehouse/edit/{id}(id=${item.maHangHoa}, page=${page}, keyword=${keyword})}" class="btn btn-sm btn-warning">Sửa</a>
            <a th:href="@{/admin/warehouse/delete/{id}(id=${item.maHangHoa})}"
               class="btn btn-sm btn-danger"
               onclick="return confirm('Bạn có chắc muốn xóa hàng hóa này?')">
              Xóa
            </a>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination" th:if="${totalPages > 1}">
      <a class="btn btn-sm"
         th:href="@{/admin/warehouse(page=${page - 1}, keyword=${keyword})}"
         th:classappend="${page <= 1 ? ' btn-disabled' : ''}">
        Trước
      </a>
      <span class="pagination-info" th:text="'Trang ' + ${page} + ' / ' + ${totalPages}"></span>
      <a class="btn btn-sm"
         th:href="@{/admin/warehouse(page=${page + 1}, keyword=${keyword})}"
         th:classappend="${page >= totalPages ? ' btn-disabled' : ''}">
        Sau
      </a>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      function formatVnNumber(value) {
        var digits = value.replace(/\D/g, '');
        if (!digits) return '';
        return digits.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }

      function syncDisplayInput(display) {
        var targetId = display.getAttribute('data-target');
        var hidden = targetId ? document.getElementById(targetId) : null;
        var digits = display.value.replace(/\D/g, '');
        if (hidden) hidden.value = digits;
        display.value = formatVnNumber(digits);
      }

      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('input[data-target]').forEach(function(input){
          syncDisplayInput(input);
          input.addEventListener('input', function(){ syncDisplayInput(input); });
          input.addEventListener('blur', function(){ syncDisplayInput(input); });
        });
      });
      /*]]>*/
    </script>
  </div>
</body>
</html>
